<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.43">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>深入拆解Tomcat | 面试指南</title><meta name="description" content="面试指南">
    <link rel="modulepreload" href="/interviewGuide/assets/app.9cc73c32.js"><link rel="modulepreload" href="/interviewGuide/assets/Tomcat.html.0f173cce.js"><link rel="modulepreload" href="/interviewGuide/assets/Tomcat.html.6a98704a.js"><link rel="prefetch" href="/interviewGuide/assets/index.html.0d4e51cb.js"><link rel="prefetch" href="/interviewGuide/assets/JVM.html.2f209008.js"><link rel="prefetch" href="/interviewGuide/assets/JavaMultiThread.html.90412268.js"><link rel="prefetch" href="/interviewGuide/assets/index.html.ca6ab405.js"><link rel="prefetch" href="/interviewGuide/assets/concurrent.html.919c6549.js"><link rel="prefetch" href="/interviewGuide/assets/javaBasic.html.e63bed73.js"><link rel="prefetch" href="/interviewGuide/assets/index.html.6ee6df9a.js"><link rel="prefetch" href="/interviewGuide/assets/Kafka.html.57eb847f.js"><link rel="prefetch" href="/interviewGuide/assets/index.html.368f0c58.js"><link rel="prefetch" href="/interviewGuide/assets/SpringForKafka.html.fbbf8265.js"><link rel="prefetch" href="/interviewGuide/assets/盲盒概率计算.html.10015222.js"><link rel="prefetch" href="/interviewGuide/assets/404.html.93146c89.js"><link rel="prefetch" href="/interviewGuide/assets/index.html.02b25d23.js"><link rel="prefetch" href="/interviewGuide/assets/JVM.html.7bd4de06.js"><link rel="prefetch" href="/interviewGuide/assets/JavaMultiThread.html.2849072d.js"><link rel="prefetch" href="/interviewGuide/assets/index.html.7105b085.js"><link rel="prefetch" href="/interviewGuide/assets/concurrent.html.044e730c.js"><link rel="prefetch" href="/interviewGuide/assets/javaBasic.html.30e462a6.js"><link rel="prefetch" href="/interviewGuide/assets/index.html.ae47d225.js"><link rel="prefetch" href="/interviewGuide/assets/Kafka.html.e1c36c88.js"><link rel="prefetch" href="/interviewGuide/assets/index.html.812618dc.js"><link rel="prefetch" href="/interviewGuide/assets/SpringForKafka.html.0d6c64d0.js"><link rel="prefetch" href="/interviewGuide/assets/盲盒概率计算.html.a1478b3d.js"><link rel="prefetch" href="/interviewGuide/assets/404.html.209bb1a8.js"><link rel="prefetch" href="/interviewGuide/assets/404.226776de.js"><link rel="prefetch" href="/interviewGuide/assets/Layout.1553faf4.js">
    <link rel="stylesheet" href="/interviewGuide/assets/style.0ee92805.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/interviewGuide/" class=""><!----><span class="site-name">面试指南</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/interviewGuide/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="主题"><span class="title">主题</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="主题"><span class="title">主题</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/interviewGuide/java/" class="router-link-active" aria-label="Java"><!--[--><!--]--> Java <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/interviewGuide/redis/" class="" aria-label="Redis"><!--[--><!--]--> Redis <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/wzliy/interviewGuide.git" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" placeholder="Search" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/interviewGuide/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="主题"><span class="title">主题</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="主题"><span class="title">主题</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/interviewGuide/java/" class="router-link-active" aria-label="Java"><!--[--><!--]--> Java <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/interviewGuide/redis/" class="" aria-label="Redis"><!--[--><!--]--> Redis <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/wzliy/interviewGuide.git" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><a href="/interviewGuide/" class="sidebar-item sidebar-heading" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a><!----></li><li><a href="/interviewGuide/java/" class="router-link-active sidebar-item sidebar-heading" aria-label="Java"><!--[--><!--]--> Java <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/interviewGuide/java/javaBasic.html" class="sidebar-item" aria-label="Java基础"><!--[--><!--]--> Java基础 <!--[--><!--]--></a><!----></li><li><a href="/interviewGuide/java/concurrent.html" class="sidebar-item" aria-label="容器"><!--[--><!--]--> 容器 <!--[--><!--]--></a><!----></li><li><a href="/interviewGuide/java/JavaMultiThread.html" class="sidebar-item" aria-label="多线程"><!--[--><!--]--> 多线程 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a href="/interviewGuide/redis/" class="sidebar-item sidebar-heading" aria-label="Redis"><!--[--><!--]--> Redis <!--[--><!--]--></a><!----></li><li><a href="/interviewGuide/消息队列/" class="sidebar-item sidebar-heading" aria-label="消息队列"><!--[--><!--]--> 消息队列 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/interviewGuide/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/Kafka.html" class="sidebar-item" aria-label="Kafka"><!--[--><!--]--> Kafka <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="深入拆解tomcat" tabindex="-1"><a class="header-anchor" href="#深入拆解tomcat" aria-hidden="true">#</a> 深入拆解Tomcat</h1><h2 id="servlet规范和servlet容器" tabindex="-1"><a class="header-anchor" href="#servlet规范和servlet容器" aria-hidden="true">#</a> Servlet规范和Servlet容器</h2><p>Servlet容器用来加载和管理业务类。Http服务器不直接跟业务类打交道，而是把请求交给Servlet容器去处理，Servlet容器会将请求转发到具体的Servlet，如果这个Servlet还没创建，就加载并实例化这个Servlet，然后调用这个Servlet的接口方法。因此，Servlet接口其实是Servlet容器跟具体业务类之间的接口。</p><p>servlet接口和servlet容器这一整套规范叫作Servlet规范。Tomcat和Jetty都按照Servlet规范的要求实现了Servlet容器，同事它们也具有HTTP服务器的功能。当我们需要实现新的业务功能时，只需要实现一个Servlet，并把它注册到Tomcat中，剩下的事情就有Tomcat帮我们处理了。</p><h3 id="servlet接口" tabindex="-1"><a class="header-anchor" href="#servlet接口" aria-hidden="true">#</a> Servlet接口</h3><p>Servlet接口定义了下面五个方法：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Servlet</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">ServletConfig</span> config<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">;</span>
    
    <span class="token class-name">ServletConfig</span> <span class="token function">getServletConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">void</span> <span class="token function">service</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> res）<span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
    
    <span class="token class-name">String</span> <span class="token function">getServletInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>其中最重要的是service方法，具体业务在这个方法里实现处理逻辑。这个方法有两个参数ServletRequest和ServletResponse。ServletRequest用来封装请求信息，ServletResponse用来封装响应信息，因此，本质上这两个类是对通信协议的封装。</p><p>HTTP协议中的请求和响应就是对应了HttpServletRequest和HttpServletResponse这两个类。</p><p>还有两个跟生命周期有关的方法init和destroy，Servlet容器在加载Servlet类的时候会调用init方法，在卸载的时候会调用destroy方法。Spring MVC中的DispatcherServlet，就是在init方法里创建了自己的Spring容器。</p><p>ServletConfig的作用是封装Servlet的初始化参数。你可以在web.xml给Servlet配置参数，并在程序里通过getServletConfig方法拿到这些参数。</p><p>有了接口一般有抽象类来实现接口和封装通用的逻辑，因此Servlet规范提供了GenericServlet抽象类，我们可以通过扩展它来实现Servlet。Servlet规范还提供了HttpServlet来继承GengericServlet，并且加入了HTTP特性。这样我们通过继承HttpServlet类实现自己的Servlet，只需要重写两个方法：doGet和doPost。</p><h3 id="servlet容器" tabindex="-1"><a class="header-anchor" href="#servlet容器" aria-hidden="true">#</a> Servlet容器</h3><p><strong>Servlet容器的工作流程</strong></p><p>当客户请求某个资源时，HTTP 服务器会用一个 ServletRequest 对象把客户的请求信息封装起来，然后调用 Servlet 容器的 service 方法，Servlet 容器拿到请求后，根据请求的 URL 和 Servlet 的映射关系，找到相应的 Servlet，如果 Servlet 还没有被加载，就用反射机制创建这个 Servlet，并调用 Servlet 的 init 方法来完成初始化，接着调用 Servlet 的 service 方法来处理请求，把 ServletResponse 对象返回给 HTTP 服务器，HTTP 服务器会把响应发送给客户端。同样我通过一张图来帮助你理解。</p><p><img src="https://static001.geekbang.org/resource/image/b7/15/b70723c89b4ed0bccaf073c84e08e115.jpg" alt="img"></p><p><strong>Servlet的注册</strong></p><p>Servlet容器会实例化和调用Servlet，那Servlet是怎么注册到Servlet容器中的呢？</p><p>一般来说，我们是以Web应用程序的方式来部署Servlet的，而根据Servlet规范，Web应用程序有一定的目录结构，在这个目录下分别放置了 Servlet 的类文件、配置文件以及静态资源，Servlet 容器通过读取配置文件，就能找到并加载 Servlet。Web 应用的目录结构大概是下面这样的：</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>
<span class="token punctuation">|</span> <span class="token punctuation">-</span>  MyWebApp
      <span class="token punctuation">|</span> <span class="token punctuation">-</span>  WEB<span class="token punctuation">-</span>INF/web.xml        <span class="token punctuation">-</span><span class="token punctuation">-</span> 配置文件，用来配置Servlet等
      <span class="token punctuation">|</span> <span class="token punctuation">-</span>  WEB<span class="token punctuation">-</span>INF/lib/           <span class="token punctuation">-</span><span class="token punctuation">-</span> 存放Web应用所需各种JAR包
      <span class="token punctuation">|</span> <span class="token punctuation">-</span>  WEB<span class="token punctuation">-</span>INF/classes/       <span class="token punctuation">-</span><span class="token punctuation">-</span> 存放你的应用类，比如Servlet类
      <span class="token punctuation">|</span> <span class="token punctuation">-</span>  META<span class="token punctuation">-</span>INF/              <span class="token punctuation">-</span><span class="token punctuation">-</span> 目录存放工程的一些信息
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>Servlet 规范里定义了 ServletContext 这个接口来对应一个 Web 应用。Web 应用部署好后，Servlet 容器在启动时会加载 Web 应用，并为每个 Web 应用创建唯一的 ServletContext 对象。你可以把 ServletContext 看成是一个全局对象，一个 Web 应用可能有多个 Servlet，这些 Servlet 可以通过全局的 ServletContext 来共享数据，这些数据包括 Web 应用的初始化参数、Web 应用目录下的文件资源等。由于 ServletContext 持有所有 Servlet 实例，你还可以通过它来实现 Servlet 请求的转发。</p><h3 id="扩展机制" tabindex="-1"><a class="header-anchor" href="#扩展机制" aria-hidden="true">#</a> 扩展机制</h3><p>Servlet 规范提供了两种扩展机制：<strong>Filter</strong> 和 <strong>Listener</strong>。</p><p>Filter 是过滤器，这个接口允许你对请求和响应做一些统一的定制化处理，比如你可以根据请求的频率来限制访问，或者根据国家地区的不同来修改响应内容。过滤器的工作原理是这样的：Web 应用部署完成后，Servlet 容器需要实例化 Filter 并把 Filter 链接成一个 FilterChain。当请求进来时，获取第一个 Filter 并调用 doFilter 方法，doFilter 方法负责调用这个 FilterChain 中的下一个 Filter。</p><p>Listener 是监听器，这是另一种扩展机制。当 Web 应用在 Servlet 容器中运行时，Servlet 容器内部会不断的发生各种事件，如 Web 应用的启动和停止、用户请求到达等。 Servlet 容器提供了一些默认的监听器来监听这些事件，当事件发生时，Servlet 容器会负责调用监听器的方法。当然，你可以定义自己的监听器去监听你感兴趣的事件，将监听器配置在web.xml中。比如 Spring 就实现了自己的监听器，来监听 ServletContext 的启动事件，目的是当 Servlet 容器启动时，创建并初始化全局的 Spring 容器。</p><p>Filter和Listener的本质区别：</p><ul><li>Filter是干预过程的，它是过程的一部分，是基于过程行为的。</li><li>Listener是基于状态的，任何行为改变同一个状态，处罚的事件是一致的。</li></ul><h3 id="实战-手动实现和运行一个servlet" tabindex="-1"><a class="header-anchor" href="#实战-手动实现和运行一个servlet" aria-hidden="true">#</a> 实战：手动实现和运行一个Servlet</h3><!--]--></div><footer class="page-meta"><!----><!----><!----></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/interviewGuide/assets/app.9cc73c32.js" defer></script>
  </body>
</html>
